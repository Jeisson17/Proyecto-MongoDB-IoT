comandos_mongodb.js
Este archivo contiene los comandos que se ejecutan en la mongosh para las operaciones CRUD, agregación y creación de índices.

javascript
// ====================================================================
// Archivo de Comandos MongoDB - Guía de Aprendizaje
// NOTA: Este archivo es una referencia. Los comandos se deben ejecutar
//       manualmente en la MongoDB Shell (mongosh) para capturar resultados.
// ====================================================================

// --- 0. Limpieza Inicial (Opcional, para "resetear" el estado) ---
// Si necesitas "resetear" la colección a su estado inicial de 120 documentos:
// Asegúrate de que MongoDB Server esté corriendo y que mongosh esté abierto.
// 1. Ejecutar en mongosh para seleccionar la DB:
// use ambiental_iot;
// 2. Eliminar todos los documentos de la colección 'lecturas_sensores':
// db.lecturas_sensores.deleteMany({});
// 3. Salir de mongosh: exit
// 4. Desde la terminal, volver a ejecutar el comando mongoimport:
// mongoimport --db ambiental_iot --collection lecturas_sensores --file datos_sensores.json --jsonArray
// ====================================================================

// --- 1. Conectarse y Seleccionar la Base de Datos ---
// Abre tu terminal y ejecuta: mongosh
// Una vez dentro de mongosh, para seleccionar o crear la base de datos:
use ambiental_iot;

// Verificar que estás en la base de datos correcta:
db; // Muestra el nombre de la base de datos actual

// Contar los documentos después de la importación (deberían ser 120 inicialmente si no has borrado):
db.lecturas_sensores.countDocuments();


// --- 2. Operaciones CRUD (Create, Read, Update, Delete) ---

// 2.1. CREATE (Insertar un nuevo documento)
// Inserta una nueva lectura de sensor manualmente.
// Usamos ISODate() para que la fecha se guarde en un formato estándar de MongoDB.
db.lecturas_sensores.insertOne(
    {
        "sensor_id": "SNSR-NEW-007",
        "ubicacion": {
            "ciudad": "Cartagena",
            "pais": "Colombia",
            "lat": 10.3910,
            "lon": -75.4794
        },
        "timestamp": ISODate("2023-10-26T15:00:00Z"), // Fecha específica
        "tipo_sensor": "Humedad",
        "metadatos": {
            "modelo": "AquaSense",
            "fabricante": "Oceanic Tech"
        },
        "mediciones": {
            "humedad": 88.3,
            "temperatura": 28.5
        },
        "estado_bateria": 95
    }
);

// 2.2. READ (Consultar documentos)

// Leer todos los documentos (limitado a 5 para no llenar la consola)
db.lecturas_sensores.find({}).limit(5);

// Leer un documento específico por su sensor_id
db.lecturas_sensores.findOne({"sensor_id": "SNSR-NEW-007"});

// Leer documentos de una ciudad específica y mostrar solo ciertos campos
db.lecturas_sensores.find(
    {"ubicacion.ciudad": "Bogota"},
    {"sensor_id": 1, "ubicacion.ciudad": 1, "mediciones.pm2_5": 1, "timestamp": 1, "_id": 0} // 1=incluir, 0=excluir
).limit(5).pretty(); // .pretty() formatea la salida para hacerla más legible

// Consultar lecturas con PM2.5 mayor a 50 (considerado un nivel alto)
db.lecturas_sensores.find(
    {"mediciones.pm2_5": {"$gt": 50}} // $gt = greater than (mayor que)
).limit(5).pretty();

// Consultar lecturas de Cali con temperatura entre 20 y 25 grados
db.lecturas_sensores.find(
    {
        "ubicacion.ciudad": "Cali",
        "mediciones.temperatura": {"$gte": 20, "$lte": 25} // $gte = greater than or equal, $lte = less than or equal
    }
).limit(5).pretty();

// Consultar lecturas que no tienen registro de CO2 (campo no existe o es null) O batería baja (< 20%)
db.lecturas_sensores.find(
    {
        "$or": [ // Operador OR: cualquiera de las condiciones debe ser verdadera
            {"mediciones.co2": {"$exists": false}}, // Campo 'co2' no existe
            {"mediciones.co2": null}, // Campo 'co2' existe pero su valor es null
            {"estado_bateria": {"$lt": 20}} // $lt = less than (menor que)
        ]
    }
).limit(5).pretty();


// 2.3. UPDATE (Actualizar documentos)

// Actualizar el estado de batería del sensor recién insertado
// $set se usa para cambiar el valor de un campo o añadir uno nuevo.
// ISODate() sin argumentos inserta la fecha/hora actual.
db.lecturas_sensores.updateOne(
    {"sensor_id": "SNSR-NEW-007"}, // Filtro: el documento a actualizar
    {"$set": {"estado_bateria": 100, "metadatos.ultima_actualizacion": ISODate()}} // Operación de actualización
);

// Verificar la actualización:
db.lecturas_sensores.findOne({"sensor_id": "SNSR-NEW-007"});

// Actualizar múltiples documentos: aumentar el valor de pm2_5 en un 10% para todos los sensores de Bogotá
// $mul se usa para multiplicar el valor de un campo numérico.
db.lecturas_sensores.updateMany(
    {"ubicacion.ciudad": "Bogota"}, // Filtro: todos los documentos de Bogotá
    {"$mul": {"mediciones.pm2_5": 1.1}} // Operación: multiplicar pm2_5 por 1.1
);

// Contar los documentos afectados (matchedCount) y modificados (modifiedCount).
// Puedes verificar un documento de Bogotá para ver el cambio:
// db.lecturas_sensores.findOne({"ubicacion.ciudad": "Bogota"});


// 2.4. DELETE (Eliminar documentos)

// Eliminar el documento del sensor recién insertado
db.lecturas_sensores.deleteOne({"sensor_id": "SNSR-NEW-007"});

// Verificar la eliminación (debería retornar null):
db.lecturas_sensores.findOne({"sensor_id": "SNSR-NEW-007"});

// Eliminar todas las lecturas del sensor SNSR-MED-002
db.lecturas_sensores.deleteMany({"sensor_id": "SNSR-MED-002"});

// Contar los documentos restantes para SNSR-MED-002 (debería ser 0):
db.lecturas_sensores.countDocuments({"sensor_id": "SNSR-MED-002"});


// --- 3. Operaciones de Agregación (Resúmenes y Estadísticas) ---
// Utilizan el pipeline de agregación para procesar datos.

// 3.1. Contar el número de lecturas por ciudad
db.lecturas_sensores.aggregate([
    {
        "$group": { // Primera etapa: agrupar documentos
            "_id": "$ubicacion.ciudad", // Campo por el cual se agrupa (el nombre de la ciudad)
            "total_lecturas": {"$count": {}} // Operador de acumulación: contar documentos en cada grupo
        }
    },
    {
        "$sort": {"total_lecturas": -1} // Segunda etapa: ordenar los resultados (descendente por total de lecturas)
    }
]);

// 3.2. Calcular promedios y máximos de mediciones por ciudad
db.lecturas_sensores.aggregate([
    {
        "$group": {
            "_id": "$ubicacion.ciudad",
            "promedio_temperatura": {"$avg": "$mediciones.temperatura"}, // Promedio de temperatura
            "promedio_humedad": {"$avg": "$mediciones.humedad"},       // Promedio de humedad
            "max_pm2_5": {"$max": "$mediciones.pm2_5"}                 // Máximo pm2_5 registrado
        }
    },
    {
        "$sort": {"max_pm2_5": -1} // Ordenar por el máximo pm2_5 (para ver las ciudades más contaminadas)
    }
]);

// 3.3. Encontrar la lectura más reciente para cada sensor
// Primero ordena para que la lectura más reciente de cada sensor esté al inicio del grupo,
// luego toma el primer documento de cada grupo.
db.lecturas_sensores.aggregate([
    {
        "$sort": {
            "sensor_id": 1,     // Ordenar por sensor_id ascendente
            "timestamp": -1     // Luego por timestamp descendente (más reciente primero)
        }
    },
    {
        "$group": {
            "_id": "$sensor_id", // Agrupar por cada sensor_id
            "ultima_lectura": {"$first": "$$ROOT"} // $$ROOT hace referencia al documento completo
        }
    }
]);

// 3.4. Contar cuántas alertas de PM2.5 (lecturas > 50) hay por ciudad y tipo de sensor
db.lecturas_sensores.aggregate([
    {
        "$match": { // Primera etapa: filtrar documentos que cumplen una condición
            "mediciones.pm2_5": {"$gt": 50} // Solo documentos con pm2_5 mayor a 50
        }
    },
    {
        "$group": { // Segunda etapa: agrupar los documentos filtrados
            "_id": {
                "ciudad": "$ubicacion.ciudad",  // Agrupar por combinación de ciudad
                "tipo_sensor": "$tipo_sensor"   // y tipo_sensor
            },
            "alertas_pm2_5_altas": {"$count": {}} // Contar las alertas en cada grupo
        }
    },
    {
        "$sort": {"alertas_pm2_5_altas": -1} // Ordenar por el número de alertas
    }
]);


// --- 4. Crear Índices para Mejorar el Rendimiento ---
// Los índices son como los índices de un libro, ayudan a encontrar la información más rápido.

// Para búsquedas frecuentes por ciudad:
print("Creando índice para 'ubicacion.ciudad'...");
db.lecturas_sensores.createIndex({"ubicacion.ciudad": 1}); // 1 para orden ascendente

// Para búsquedas por sensor_id y fecha (común para series de tiempo):
print("Creando índice para 'sensor_id' y 'timestamp'...");
db.lecturas_sensores.createIndex({"sensor_id": 1, "timestamp": -1}); // sensor_id ascendente, timestamp descendente

// Ver los índices creados:
print("Índices actuales en la colección 'lecturas_sensores':");
db.lecturas_sensores.getIndexes();

// Demostración del uso de índice (implícito al buscar por los campos indexados):

// Esta consulta debería usar el índice en 'ubicacion.ciudad'
print("Consultando lecturas de Medellín (usando índice de ciudad):");
db.lecturas_sensores.find({"ubicacion.ciudad": "Medellin"}).limit(5).pretty();

// Esta consulta debería usar el índice compuesto en 'sensor_id' y 'timestamp'
print("Consultando las últimas 3 lecturas del sensor 'SNSR-BOG-001' (usando índice compuesto):");
db.lecturas_sensores.find({"sensor_id": "SNSR-BOG-001"})
    .sort({"timestamp": -1})
    .limit(3)
    .pretty();


// --- 5. Eliminar la Base de Datos (Opcional, para limpiar completamente) ---
// Si en algún momento quieres eliminar toda la base de datos ambiental_iot:
// use ambiental_iot;
// db.dropDatabase();
// Ten CUIDADO con este comando, elimina todo permanentemente.
